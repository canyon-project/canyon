# ソースコードカバレッジの復元

フロントエンドアプリケーションのコンパイル形態は様々で、多くの場合、事前コンパイルされたASTがbabelによって変換されます。これによりカバレッジを直接ソースコードにマッピングできなくなるため、ソースコードカバレッジを復元する必要があります。

## Source Map

>
> フロントエンド開発では、通常JavaScriptコードを圧縮、難読化したり、プリプロセッサ（TypeScript、Babelなど）を使用して変換し、パフォーマンスと互換性を向上させます。これらの処理により、最終的に本番環境にデプロイされるコードは元のソースコードと大きく異なり、デバッグが困難になります。Source Mapはこの問題を解決し、コンパイル後のコードと元のコードの間のマッピング関係を記録することで、開発者がブラウザの開発者ツールで元のコードを表示してデバッグできるようにします。 -- [web.dev](https://web.dev/articles/source-maps)

ほとんどの場合、sourceMapファイルを手動で取得する必要はありません。多くのビルドツールは「事前コンパイルされたASTをbabelに渡して変換する」過程でsourceMapファイルを渡しているためです。

ただし、特定の状況ではsourceMapファイルを設定する必要がある場合があります。

## sourceMapオプションを有効にする場合

```js filename="webpack.config.js" {4}
const path = require('path');

module.exports = {
  entry: './build/main.js',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'bundle.js'
  },
  module:{
    rules: [
      {
        test: /\.(js|jsx)$/,
        use:['babel-loader'],
        exclude:'/node_modules/'
      }
    ]
  }
};
```

この例では、webpackのエントリーファイルは`./build/main.js`で、これはtsがtsファイルをコンパイルした成果物です。tsconfig.jsonの`sourceMap`を`true`に設定する必要があります。__これによりsourceMapデータの伝達が保証されます。__

```json filename="tsconfig.json" {3}
{
  "compilerOptions": {
    "sourceMap": true
  }
}
```

## sourceMapを手動で設定する場合

sourceMapの生成方法が以下の場合、手動で設定する必要があります。

| 分類              | devtool                       |  説明                                    |
|-------------------|-------------------------------|-----------------------------------------|
| sourceMapファイルを生成するがソースコードを表示しない   | hidden-source-map             |  ファイルの末尾でmapファイルを参照しない                 |
| sourceMapファイルを生成するがソースコードを表示しない   | nosources-source-map           | ファイルの末尾でmapファイルを参照しない                 |

### sourceMapを手動で設定する方法

この場合、[hitとmapの分離](/docs/core-concepts/separate-hit-and-map)を使用して、`canyon-uploader`でビルド段階でローカルのsourceMapファイルを検出する必要があります。Canyonはこれらをカバレッジ初期データと照合してアップロードします。

> [!NOTE]
>
> これはjavascriptが過度に柔軟であることの欠点の一つです。正確なソースコードカバレッジデータを収集するには、これらのsourceMapファイルを連携させ、コード計装が正しくソースコードにマッピングされるようにする必要があります。
