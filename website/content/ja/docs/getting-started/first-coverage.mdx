import { Steps, Callout, Cards } from "nextra/components";

# 最初のカバレッジデータ

> [!NOTE]
>
> Canyonは[一般的なフレームワークのインストールガイド](/docs/installation/getting-started)を提供し、素早く始められるようサポートします。

以下の手順に従って最初のカバレッジデータレポートを完了してください：

## 新規プロジェクトとして開始

<Steps>
  ### インストール

フロントエンドエンジニアリングとモジュラー開発では、Babelが不可欠です。Babelプロジェクトでは、2つのBabelプラグインをインストールするだけで素早く始められます。

```sh npm2yarn
npm install babel-plugin-istanbul babel-plugin-canyon -D
```

[Babel設定ファイル](https://babeljs.io/docs/config-files#configuration-file-types)に[`istanbul`](https://www.npmjs.com/package/babel-plugin-istanbul)と[`canyon`](https://www.npmjs.com/package/babel-plugin-canyon)プラグインを追加します：

  ```js filename="babel.config.js" {3,4} copy
  module.exports = {
    plugins: [
      'istanbul',
      'canyon'
      // プラグインの順序に注意してください。canyonプラグインはistanbulプラグインの後に配置する必要があります
      ],
  };
  ```

### 検証

設定後、プロジェクトを起動し、コンソールで**window.\_\_coverage\_\_**を出力します。出力が下の画像と一致する場合、コードインストルメンテーションが成功したことを意味します。

![coverage-canyon-console](https://cdn.jsdelivr.net/gh/canyon-project/assets/docs/static/documentation/getting-started/first-coverage/coverage-canyon-console.png)

### CI環境変数の設定

CI環境では、カバレッジデータを報告するためにいくつかの環境変数を設定する必要があります。

> [!TIP]
>
> Canyonはコンパイル時にパイプライン変数を検出し、複数の[パイプラインプロバイダー](/docs/reference/provider)に適応しています。<br/>
> お使いのパイプラインプロバイダーが見つからない場合は、[明示的な設定](/docs/ecosystem/babel-plugin-canyon#configuration)を試してください。

1. `DSN`と`REPORTER`

- **DSN**: カバレッジデータ報告のサービスアドレス、\{\{url\}\}/coverage/client、ここで\{\{url\}\}はCanyonサービスアドレスです。
- **REPORTER**: ユーザートークン、Canyonユーザー設定ページで確認できます。

2. CIプラットフォーム変数の設定

![gitlab](https://cdn.jsdelivr.net/gh/canyon-project/assets/docs/static/documentation/getting-started/first-coverage/gitlab-var-config.png)

<Callout type="info" emoji="ℹ️">
  プロジェクトID、ブランチ、SHAは手動で設定する必要はありません。Canyonプラグインが自動的にパイプライン環境変数を検出します。
</Callout>

  ### Babelプラグインのアクティベーション条件の更新

  __CI段階では、本番ブランチでのインストルメンテーションを防ぐために、プラグインのアクティベーション条件を制御する必要があります。__

  ```js {2,3} copy
  module.exports = {
    plugins: (process.env.CI &&
              process.env.CI_COMMIT_REF_NAME !== 'release')
              ? [
                'canyon',
                'istanbul'
              ]:[],
  };
  ```

  ### カバレッジデータの報告

  CI完了を待ち、ページをテスト環境にデプロイします。

  この時点で、カバレッジデータはブラウザに保存されています。ユーザーが操作したりUI自動化テストが実行されたりすると、window.__coverage___データが継続的に蓄積されます。

  このデータをCanyonサーバーに正確に報告することで、カバレッジデータのリアルタイム表示が可能になります。

  カバレッジデータを報告する方法は以下の通りです：

  <Cards>
  <Cards.Card
    title="UI自動化テスト"
    href="/docs/end-to-end-testing/playwright"
  />
  <Cards.Card
    title="手動テスト"
    href="/docs/ecosystem/canyon-extension"
  />
</Cards>
</Steps> 