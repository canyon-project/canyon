name: Get changed lines
on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main,dev]

jobs:
  diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        uses: actions/github-script@v7
        id: diff
        with:
          script: |
            let result = [];
            
            if (context.eventName === 'pull_request') {
              // PR 触发时获取 PR 的文件变更
              const pr = context.payload.pull_request.number;
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr
              });

              result = files.map(f => {
                return {
                  filename: f.filename,
                  patch: f.patch,
                  status: f.status,
                  additions: f.additions,
                  deletions: f.deletions,
                  changes: f.changes
                };
              });
            } else if (context.eventName === 'push') {
              // Push 触发时获取 commit 的文件变更
              const { data: commit } = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha
              });

              result = commit.files.map(f => {
                return {
                  filename: f.filename,
                  patch: f.patch,
                  status: f.status,
                  additions: f.additions,
                  deletions: f.deletions,
                  changes: f.changes
                };
              });
            }

            console.log("Changed files:", result);
            
            // 将结果写入环境变量，供后续步骤使用
            const fs = require('fs');
            fs.writeFileSync('changed-files.json', JSON.stringify(result, null, 2));
            
            return result;

      - name: Write changes to file
        run: |
          echo "Writing changed files information to local file..."
          cat changed-files.json
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: changed-files-${{ github.run_id }}
          path: changed-files.json
          retention-days: 30
