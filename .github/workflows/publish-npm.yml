name: publish-npm

on:
  push:
    branches: [ "*" ]

jobs:
  publish-npm:
    runs-on: ubuntu-latest
    steps:
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/
      - run: pnpm install
      - run: pnpm run build
      # ÂèëÂ∏ÉÊâÄÊúâÈùû private ÁöÑÂåÖ
      - name: Publish packages
        run: |
          # ÈÅçÂéÜ packages ÁõÆÂΩïÔºåÂè™ÂèëÂ∏ÉÈùû private ÁöÑÂåÖ
          for package_dir in packages/*/; do
            if [ -f "$package_dir/package.json" ]; then
              package_name=$(node -p "require('$package_dir/package.json').name")
              is_private=$(node -p "require('$package_dir/package.json').private || false")
              
              if [ "$is_private" != "true" ]; then
                echo "üì¶ Publishing $package_name from $package_dir"
                cd "$package_dir"
                pnpm publish --access public --no-git-checks || echo "‚ö†Ô∏è Failed to publish $package_name"
                cd - > /dev/null
              else
                echo "‚è≠Ô∏è  Skipping private package: $package_name"
              fi
            fi
          done
        continue-on-error: true
        env:
          NODE_AUTH_TOKEN: ${{secrets.NODE_AUTH_TOKEN}}
