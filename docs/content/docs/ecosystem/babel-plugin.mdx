import { GithubOutlined } from "@ant-design/icons";
import { Button } from "antd";

# @canyonjs/babel-plugin

<div className={'h-10'}></div>

<Button target={'_blank'} href={'https://github.com/canyon-project/canyon/tree/main/plugins/@canyonjs/babel-plugin'} icon={<GithubOutlined />} size={'small'}>Source</Button>

A Babel plugin for detecting CI environment variables. Works with istanbuljs to complete code instrumentation.

## Usage

Install:

```sh
npm install --save-dev @canyonjs/babel-plugin
```

Add these configurations in `babel.config.js`:

```js
module.exports = {
  plugins:
    process.env.CI_COMMIT_REF_NAME === "test-coverage"
      ? ["istanbul", "canyon"]
      : [],
      // Note the plugin order: canyon plugin should be after istanbul plugin
};
```

It does two things:

1. Detect CI pipeline variables
2. 收集参与编译的文件覆盖率初始数据

## Configuration

babel.config.js

```js
module.exports = {
  plugins: [
    "istanbul",
    [
      "canyon",
      {
        // #region == Step 2: CI Provider auto-detection, generally no manual configuration needed, see Support Provider documentation for details
        repoID: "230614", // Repository ID
        sha: "xxxxxxxxx", // Git Commit SHA
        // #endregion
        // #region == Step 4: Separate hit and map data (optional)
        keepMap: false, // Keep coverage map, optional, default is false.
        // #endregion
        // #region == Step 5: Other configuration (optional)
        instrumentCwd: "/path/to", // Instrumentation working directory, may need manual configuration in multi-repo mode
        provider: "gitlab", // Source code provider (optional), default is gitlab
        // #endregion
      },
    ],
  ],
};
```

| Configuration Item | Description                                                                                                          | Required                                       | Default        |
| ------------- | ------------------------------------------------------------------------------------------------------------- | ---------------------------------------------- | ------------- |
| dsn           | Coverage reporting address, CI pipeline variable KEY is DSN                                                                   | Yes (fill in CI variable configuration or manual explicit configuration as needed) | None            |
| reporter      | User token for distinguishing different users, CI pipeline variable KEY is REPORTER                                               | Yes (fill in CI variable configuration or manual explicit configuration as needed) | None            |
| repoID     | Repository ID                                                                                                        | Generally no manual configuration needed (auto-detect CI Provider)      | None            |
| sha           | Git Commit SHA                                                                                                | Generally no manual configuration needed (auto-detect CI Provider)      | None            |
| branch        | Git repository branch                                                                                                   | Generally no manual configuration needed (auto-detect CI Provider)      | None            |
| reportID      | Used to distinguish different test cases                                                                                        | Optional                                           | None            |
| compareTarget | Comparison target, used as baseline for current SHA, for calculating changed line coverage                                                           | Optional                                           | None            |
| keepMap       | Keep coverage map, optional, default is true, when false, will generate .canyon_output file                                       | Optional                                           | true          |
| instrumentCwd | Instrumentation working directory, may need manual configuration in multi-repo mode                                                                  | Optional                                           | process.cwd() |
| provider      | Source code provider (optional), default is gitlab                                                                          | Optional                                           | gitlab        |
| oneByOne      | Configure proxy server, optional, default is false. When true, will report initial coverage data for each file one by one during compilation. Can also be proxy server configuration | Optional                                           | false         |
