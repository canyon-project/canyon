# Map & Hit Protocol

> **Status**: Draft  
> **Version**: 1.0.0-alpha

## Overview

This document defines the API protocol for reporting coverage maps and hits. It describes the payload structure, required fields, and behavioral semantics.

## Protocol Principles

1. **Separation**: Map and Hit are separate endpoints
2. **Fail-Open**: Hit reporting must never block execution
3. **Idempotency**: Map reporting is idempotent
4. **Minimal**: Hit payload is minimal (no business context)

## Map Endpoint

### POST /api/coverage/map

Reports coverage map structure (build-time).

**When**: During CI/CD build phase

**Authentication**: Required (CI token)

**Idempotent**: Yes (same mapHash can be reported multiple times)

### Request Payload

```typescript
{
  // Build context (required)
  provider: string;           // "gitlab", "github"
  repoID: string;             // Repository identifier
  commitSha: string;          // Git commit SHA
  buildTarget: string;        // "web", "ios", "android"
  
  // Optional build context
  pipelineId?: string;
  buildId?: string;
  
  // Plugin metadata (required)
  pluginVersion: string;      // "1.0.0"
  schemaVersion: number;      // 2
  
  // Scene context (optional)
  sceneKey?: string;
  tags?: Record<string, string>;
  
  // Maps (array of file maps)
  maps: Array<{
    mapHash: string;          // Required: structure identity
    filePath: string;          // Relative file path
    fileContentHash?: string; // Optional: source content hash
    coverageMap: {            // Istanbul-compatible structure
      s: Record<string, StatementMap>;
      f: Record<string, FunctionMap>;
      b: Record<string, BranchMap>;
    };
    sourceMap?: string;       // Optional: base64 source map
  }>;
}
```

### Response

```typescript
{
  success: boolean;
  mapCount: number;           // Number of maps processed
  errors?: Array<{
    mapHash: string;
    error: string;
  }>;
}
```

### Behavior

- Maps with same `mapHash` are deduplicated
- Missing `mapHash` is computed server-side (not recommended)
- Invalid maps are rejected with error details

## Hit Endpoint

### POST /api/coverage/hit

Reports coverage execution data (runtime).

**When**: During test execution or runtime

**Authentication**: Optional (public endpoint)

**Idempotent**: No (hits are additive)

**Fail-Open**: Must never throw or block

### Request Payload

```typescript
{
  // Identity (required)
  mapHash: string;           // Required: structure identity
  
  // Optional identity
  buildHash?: string;         // Optional: build identity
  sceneKey?: string;          // Optional: execution context
  
  // Execution data (required)
  hits: {
    s?: Record<string, number>;  // Statement hits
    f?: Record<string, number>;  // Function hits
    b?: Record<string, [number, number]>; // Branch hits
  };
  
  // Metadata
  ts?: number;                // Timestamp (Unix epoch)
}
```

### Response

```typescript
{
  success: boolean;
  // No detailed error information (fail-open)
}
```

### Behavior

- **Fail-Open**: Invalid hits are silently dropped
- **Async**: Response returned immediately, processing is async
- **No Validation**: Server does not validate `mapHash` existence (async lookup)

## Field Semantics

### mapHash

- **Required**: Yes (in both endpoints)
- **Purpose**: Links hit to map structure
- **Format**: Hex string (SHA-256)
- **Computed**: Client-side (recommended) or server-side (fallback)

### sceneKey

- **Required**: No
- **Purpose**: Execution context signature
- **Format**: Hex string (hash of scene fields)
- **Computed**: Client-side from normalized scene fields

### tags

- **Required**: No
- **Purpose**: Filtering and aggregation dimensions
- **Format**: Key-value map
- **Note**: Not part of merge identity

## Versioning

### Protocol Version

Include in headers or payload:

```
X-Canyon-Protocol-Version: 1.0
```

### Backward Compatibility

- New optional fields: Always accepted
- Removed fields: Deprecated, then removed in next major version
- Required fields: Cannot be removed

## Error Handling

### Map Endpoint

- **400**: Invalid payload structure
- **401**: Authentication required
- **500**: Server error (retry recommended)

### Hit Endpoint

- **200**: Always returned (fail-open)
- Errors are logged server-side, not returned to client

## Security Considerations

### Map Endpoint

- Requires authentication (CI token)
- Rate limiting: Moderate (per build)
- Payload size: Large (maps can be MB)

### Hit Endpoint

- Public endpoint (no auth required)
- Rate limiting: Aggressive (per IP)
- Payload size: Small (hits are KB)
- Hash whitelist: Only accept known mapHashes (optional)

## Next Steps

- [Coverage Data Model](/docs/specification/data-model) - Core entities
- [Fail-Open Semantics](/docs/specification/fail-open) - Error handling

