# Coverage Data Model

> **Status**: Draft  
> **Version**: 1.0.0-alpha  
> **Last Updated**: 2025-01-XX

## Overview

This document defines the core data model for Canyon coverage collection system. It describes the fundamental entities, their relationships, and invariants that govern how coverage data is structured, stored, and merged.

## Scope

This specification covers:

- Core entities: Coverage Map, Coverage Hit, Scene, Version
- Identity model: How coverage data is uniquely identified
- Data immutability principles
- Merge semantics and rules

## Non-Goals

This specification does not cover:

- Implementation details (NestJS, ClickHouse, PostgreSQL)
- UI/UX design
- CI/CD integration specifics
- Plugin implementation details

## Core Entities

### Coverage Map

A Coverage Map represents the **structure** of instrumented code. It describes:

- Which statements, functions, and branches exist
- Their locations in source code
- Source map mappings

**Key Properties:**

- Immutable once created
- Reusable across multiple builds
- Identified by `mapHash`

### Coverage Hit

A Coverage Hit represents **runtime execution** data. It contains:

- Execution counts for statements, functions, branches
- Timestamp of collection
- Associated `mapHash` reference

**Key Properties:**

- Mutable (counts can be incremented)
- Lightweight (no structural information)
- Identified by `mapHash + sceneKey + timestamp`

### Scene

A Scene represents the **execution context** of coverage collection. It describes:

- How the coverage was collected (automation, manual, replay)
- Where it was collected (environment, trigger)
- What tool was used (playwright, jest, etc.)

**Key Properties:**

- Defined by structured fields (source, type, env, trigger)
- Used for aggregation and filtering
- Not part of identity (doesn't affect merge decisions)

### Version

A Version represents a **code revision**. It identifies:

- Repository (provider + repoID)
- Commit SHA
- Build target

**Key Properties:**

- Stable across multiple builds
- Used for version-level aggregation
- Identified by `versionID` / `revisionHash`

## Identity Model

Canyon uses a multi-layered identity system:

| Identity | Purpose | Used In |
|----------|---------|---------|
| `mapHash` | Code structure fingerprint | Hit, Map |
| `versionID` | Code revision identity | Build, Version |
| `sceneKey` | Execution context signature | Hit, Scene |
| `fileContentHash` | Source file content fingerprint | Map |

### Identity Rules

1. **One identity, one purpose**: Each hash answers exactly one question
2. **Immutable**: Identities never change once assigned
3. **Versioned**: Hash algorithms can evolve, but must be versioned

## Data Immutability

### Map Immutability

- Coverage Maps are **immutable** once created
- Same `mapHash` always refers to the same structure
- Maps can be reused across builds/versions

### Hit Mutability

- Coverage Hits are **mutable** (counts can be incremented)
- Multiple hits with same `mapHash + sceneKey` can be merged
- Merging preserves idempotency

## Relationships

```
Version (versionID)
  └─ Build (buildHash)
      └─ Map (mapHash)
          └─ Hit (mapHash + sceneKey)
```

## Next Steps

- [Identity & Hash Model](/docs/specification/identity-model) - Detailed hash design
- [Merge Semantics](/docs/specification/merge-semantics) - When and how to merge
- [Map & Hit Protocol](/docs/specification/protocol) - API contract

