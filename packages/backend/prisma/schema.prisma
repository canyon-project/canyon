datasource db {
  provider = "postgresql"
}

generator client {
  provider   = "prisma-client"
  engineType = "client"
  output   = "../src/generated
}

model InfraConfig {
  id                     String   @id @default(cuid())
  name                   String   @unique
  value                  String
  createdOn              DateTime @default(now()) @db.Timestamptz(3)
  updatedOn              DateTime @updatedAt @db.Timestamptz(3)
  isEncrypted            Boolean  @default(false)
  lastSyncedEnvFileValue String

  @@map("canyon_final_infra_config")
}

model Repo {
  id                String   @id
  pathWithNamespace String   @map("path_with_namespace")
  description       String
  config            String
  bu                String
  createdAt         DateTime @map("created_at")
  updatedAt         DateTime @map("updated_at")
  tags              Json
  members           Json

  @@map("canyon_final_repo")
}

model Project {
  id                String @id
  name              String
  pathWithNamespace String @map("path_with_namespace")
  description       String
  bu                String
  tags              Json
  members           Json
  autoInstrument    Json?  @map("auto_instrument")
  coverage          String
  defaultBranch     String @map("default_branch")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamp(3)

  @@map("project")
}

model Log {
  id        String   @id @default(cuid())
  content   Json
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  @@map("canyon_final_log")
}

model Coverage {
  id             String   @id
  provider       String
  repoID         String   @map("repo_id")
  sha            String
  branches       String?
  builds         Json?
  instrumentCwd  String   @map("instrument_cwd")
  reportProvider String   @map("report_provider")
  reportID       String   @map("report_id")
  versionID      String   @map("version_id")
  reporter       String
  buildTarget    String   @map("build_target")
  createdAt      DateTime @map("created_at")
  updatedAt      DateTime @map("updated_at")

  @@index([provider])
  @@index([repoID], name: "repo_id_idx")
  @@index([sha])
  @@map("canyon_final_coverage")
}

model CoverageSourceMap {
  hash      String @id
  sourceMap Bytes  @map("source_map")

  @@map("canyon_final_coverage_source_map")
}

model CoverageMapRelation {
  id                  String @id
  versionID           String @map("version_id")
  coverageMapHashID   String @map("coverage_map_hash_id")
  fullFilePath        String @map("full_file_path")
  restoreFullFilePath String @map("restore_full_file_path")
  filePath            String @map("file_path")
  sourceMapHashID     String @map("source_map_hash_id")
  contentHashID       String @map("content_hash_id")

  @@index([versionID])
  @@index([coverageMapHashID])
  @@map("canyon_final_coverage_map_relation")
}

model CoverMap {
  hash    String   @id
  origin  Json
  restore Json
  ts      DateTime

  @@map("canyon_final_map")
}

model CoverHit {
  id             String   @id
  coverageID     String   @map("coverage_id")
  versionID      String   @map("version_id")
  filePath       String   @map("file_path")
  s              Json
  f              Json
  b              Json
  inputSourceMap Int?     @map("input_source_map")
  aggregated     Boolean
  ts             DateTime

  @@index([coverageID])
  @@index([versionID])
  @@map("canyon_final_hit")
}

model CoverHitAgg {
  coverageID String   @map("coverage_id")
  versionID  String   @map("version_id")
  filePath   String   @map("file_path")
  s          Json
  f          Json
  b          Json
  latestTs   DateTime @map("latest_ts")

  @@id([coverageID, versionID, filePath])
  @@map("canyon_final_hit_agg")
}

model Diff {
  id String @id @default(cuid())

  provider   String
  repo_id    String
  from       String
  to         String
  path       String
  additions  Int[]
  deletions  Int[]
  subject    String
  subject_id String

  @@map("canyon_final_diff")
}
