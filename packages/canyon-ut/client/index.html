<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <style>
    a {
      color: #0071c2;
    }

    a:hover {
      color: #0071c2;
      opacity: 0.8;
      text-decoration: underline;
    }
  </style>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.13/dayjs.min.js"></script>
  <script src="https://unpkg.com/react@18.3.1/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/antd@5.23.2/dist/antd.min.js"></script>
  <script src="https://unpkg.com/axios@1.7.9/dist/axios.min.js"></script>
  <script src="https://unpkg.com/ahooks@3.8.4/dist/ahooks.js"></script>
  <script src="https://unpkg.com/@ant-design/icons@5.6.0/dist/index.umd.js"></script>
  <script src="https://unpkg.com/@monaco-editor/loader@1.4.0/lib/umd/monaco-loader.min.js"></script>
</head>
<body>
<div id="root"></div>
</body>
<script src="https://unpkg.com/canyon-report/dist/canyon-report.umd.js"></script>
<script>
  // needMock
</script>
<script type="text/babel">
  const {createRoot} = ReactDOM;
  const {useEffect, useState} = React;
  const {ConfigProvider} = antd;
  const reportName = window.reportName;
  const date = window.date;
  const useRequest = ahooks.useRequest;

  function getDecode(str) {
    return decodeURIComponent(
      atob(str)
        .split("")
        .map(function (c) {
          return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
        })
        .join(""),
    );
  }

  function handleSelectFile({filepath, reportID, sha, projectID}) {
    const fileContentRequest = axios
      .get(`/api/sourcecode`, {
        params: {
          projectID: projectID,
          sha: sha,
          filepath: filepath,
        },
      })
      .then(({data}) => data);
    const fileCoverageRequest = axios
      .get(`/api/coverage/map`, {
        params: {
          projectID,
          reportID: reportID,
          sha: sha,
          filepath: filepath,
        },
      })
      .then(({data}) => data[filepath || ""]);

    const fileCodeChangeRequest = axios
      .get(`/api/codechange`, {
        params: {
          sha: sha,
          filepath: filepath,
        },
      })
      .then(({data}) => data);
    return Promise.all([
      fileContentRequest,
      fileCoverageRequest,
      fileCodeChangeRequest,
    ]).then(([fileContent, fileCoverage, fileCodeChange]) => {
      return {
        fileContent: getDecode(fileContent.content),
        fileCoverage: fileCoverage,
        fileCodeChange: fileCodeChange.additions || [],
      };
    });
  }

  function App() {

    const currentUrl = new URL(window.location.href);
    const sha = currentUrl.searchParams.get("sha");
    const id = currentUrl.searchParams.get("id");

    const [activatedPath, setActivatedPath] = useState(
      currentUrl.searchParams.get('filepath') || ""
    );

    const {data: dataSource} = useRequest(() => {
      return axios.get(`/api/coverage/summary/map?sha=${sha}&projectID=${id}`).then((res) => {
        return res.data;
      });
    });

    function onSelect(val) {

      setActivatedPath(val);
      if (!val.includes(".")) {
        return Promise.resolve({
          fileContent: "",
          fileCoverage: {},
        });
      }
      return handleSelectFile({
        filepath: val,
        reportID: null,
        sha: sha || "",
        projectID: id || "",
      }).then((res) => {
        return {
          fileContent: res.fileContent,
          fileCoverage: res.fileCoverage,
          fileCodeChange: res.fileCodeChange,
        };
      });

    }

    // 导航
    useEffect(() => {
      const currentUrl = new URL(window.location.href);

// 设置单个参数
      currentUrl.searchParams.set('filepath', activatedPath);

// 设置多个参数
//       currentUrl.searchParams.set('param2', 'value2');

// 获取更新后的完整 URL
      const newUrl = currentUrl.toString();

// 使用 pushState 方法更新历史记录和地址栏 URL
      history.pushState({}, '', newUrl);
    }, [activatedPath]);

    return (
      <div className={"p-[10px] pb-0"}>
        <div style={{minHeight: "calc(100vh - 50px)"}}>
          <ConfigProvider
            theme={{
              token: {
                colorPrimary: "#0071c2",
              },
              // algorithm: isDark ? [darkAlgorithm] : [],
            }}
          >
            <CanyonReport
              value={activatedPath}
              name={reportName}
              dataSource={dataSource || {}}
              onSelect={onSelect}
            />
          </ConfigProvider>
        </div>
        <footer
          style={{
            color: "rgba(0,0,0,0.5)",
            fontSize: "12px",
            textAlign: "center",
            padding: "10px",
          }}
          className={"text-center p-[10px]"}
        >
          Code coverage generated by{" "}
          <a
            href="https://github.com/canyon-project/canyon/"
            target="_blank"
            rel="noreferrer"
          >
            canyon
          </a>{" "}
          at {date}
        </footer>
      </div>
    );
  }

  createRoot(document.getElementById("root")).render(
    <App/>,
  );
</script>
</html>
